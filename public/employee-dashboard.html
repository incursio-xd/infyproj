<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Dashboard</title>
    <script src="https://kit.fontawesome.com/64d58efce2.js" crossorigin="anonymous"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); min-height: 100vh; }
        
        .header { 
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(20px); 
            padding: 1rem 2rem; 
            color: white; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .dashboard-container { display: flex; height: calc(100vh - 80px); }
        
        .employee-details, .camera-access { width: 50%; padding: 2rem; color: white; }
        
        .profile-card, .camera-card { 
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(20px); 
            border-radius: 20px; 
            padding: 2rem; 
        }
        
        .camera-btn { 
            background: linear-gradient(135deg, #4ecdc4, #44a08d); 
            color: white; 
            border: none; 
            padding: 1rem 2rem; 
            border-radius: 15px; 
            cursor: pointer; 
            margin: 0.5rem; 
        }
        
        .camera-modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.9); 
        }

        .camera-modal .sidebar {
    max-height: calc(100vh - 200px);
    overflow-y: auto;
    overflow-x: hidden;
}
/* For the right sidebar in Camera 2 */
#camera2Modal > div > div:last-child > div:last-child {
    max-height: calc(100vh - 150px);
    overflow-y: auto !important;
    overflow-x: hidden;
    padding-right: 0.5rem;
}

/* Custom scrollbar for sidebar */
#camera2Modal > div > div:last-child > div:last-child::-webkit-scrollbar {
    width: 8px;
}

#camera2Modal > div > div:last-child > div:last-child::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
}

#camera2Modal > div > div:last-child > div:last-child::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 4px;
}

#camera2Modal > div > div:last-child > div:last-child::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
}

/* Ensure zones list doesn't get cut off */
#zonesList2 {
    max-height: none !important;
    margin-bottom: 2rem;
}
        
        .video-container { 
            position: relative; 
            background: rgba(255, 255, 255, 0.05); 
            border-radius: 15px; 
            flex: 1; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }
        
        #webcamVideo, #recordedVideo { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
        }
        
        #drawingCanvas2 { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            pointer-events: none; 
            z-index: 10; 
        }
        #drawingCanvas1 { 
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    pointer-events: none;  /* Default: no interaction */
    z-index: 10; 
}
        
        #drawingCanvas1.drawing-active, #drawingCanvas2.drawing-active { 
            cursor: crosshair; 
            pointer-events: auto !important; 
            z-index: 50; 
        }
        
        .btn { 
            background: linear-gradient(135deg, #4ecdc4, #44a08d); 
            color: white; 
            border: none; 
            padding: 0.75rem 1.5rem; 
            border-radius: 25px; 
            cursor: pointer; 
            margin: 0.25rem; 
        }
        
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-danger { background: linear-gradient(135deg, #ff6b6b, #ee5a52); }
        
        .message { 
            position: fixed; 
            top: 100px; 
            right: 2rem; 
            padding: 1rem 1.5rem; 
            border-radius: 12px; 
            z-index: 1001; 
        }
        
        .message.success { background: rgba(76, 175, 80, 0.9); color: white; }
        .message.error { background: rgba(244, 67, 54, 0.9); color: white; }
        .message.info { background: rgba(33, 150, 243, 0.9); color: white; }
        .video-preview-controls {
    position: absolute;
    bottom: 15px;
    left: 15px;
    right: 15px;
    background: rgba(0, 0, 0, 0.9);
    border-radius: 12px;
    padding: 0.75rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    z-index: 35;
}

.play-pause-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.video-time {
    color: white;
    font-size: 0.9rem;
    min-width: 120px;
    text-align: center;
}

.video-scrubber {
    flex: 1;
    height: 8px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 4px;
    cursor: pointer;
    position: relative;
}

.video-progress {
    height: 100%;
    background: linear-gradient(90deg, #4ecdc4, #44a08d);
    border-radius: 4px;
    width: 0%;
}

.volume-control {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.volume-icon {
    color: white;
    cursor: pointer;
}

.volume-slider {
    width: 60px;
    height: 4px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 2px;
    cursor: pointer;
    position: relative;
}

.volume-level {
    height: 100%;
    background: #4ecdc4;
    border-radius: 2px;
    width: 50%;
}

.video-item {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.video-item:hover {
    background: rgba(255, 255, 255, 0.2);
}

.video-item.selected {
    background: rgba(78, 205, 196, 0.3);
    border: 1px solid #4ecdc4;
}
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-user"></i> Employee Dashboard</h1>
        <div>
            <span id="employee-name">Welcome!</span>
            <button onclick="logout()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 25px; cursor: pointer;">Logout</button>
        </div>
    </div>

    <div class="dashboard-container">
        <div class="employee-details">
            <div class="profile-card">
                <h2><i class="fas fa-user-circle"></i> Profile</h2>
                <div id="profile-info"></div>
            </div>
        </div>

        <div class="camera-access">
            <div class="camera-card">
                <h2><i class="fas fa-video"></i> Cameras</h2>
                <p>Camera 1: Pi5 Live | Camera 2: Local Video</p>
                <div>
                    <button class="camera-btn" onclick="openCamera1()">
                        <i class="fas fa-video"></i> Camera 1 (Pi5)
                    </button>
                    <button class="camera-btn" onclick="openCamera2()">
                        <i class="fas fa-video"></i> Camera 2 (Video)
                    </button>
                    <button class="camera-btn" onclick="openAnalyticsDashboard()" style="background: linear-gradient(135deg, #667eea, #764ba2);">
        <i class="fas fa-chart-line"></i> Analytics Dashboard
    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Camera 1 Modal (Pi5) -->
    <div id="camera1Modal" class="camera-modal">
        <div style="width: 98%; height: 98%; margin: 1% auto; padding: 1rem; color: white;">
            <div style="display: flex; justify-content: space-between; padding-bottom: 1rem;">
                <h3><i class="fas fa-video"></i> Camera 1 - Pi5 Live</h3>
                <button onclick="closeCameraModal(1)" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.5rem; width: 40px; height: 40px; border-radius: 50%; cursor: pointer;">&times;</button>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 320px; gap: 1rem; height: calc(100% - 60px);">
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 15px; display: flex; gap: 1rem;">
                        <button id="startPi5" class="btn"><i class="fas fa-play"></i> Connect Pi5</button>
                        <button id="stopPi5" class="btn btn-danger" disabled><i class="fas fa-stop"></i> Disconnect</button>
                        <button id="drawZone1" class="btn" disabled><i class="fas fa-draw-polygon"></i> Draw Zone</button>
                        <button id="syncZones1" class="btn" disabled><i class="fas fa-sync"></i> Sync Zones</button>
                        <button id="startYolo1" class="btn" disabled><i class="fas fa-brain"></i> Start YOLO</button>
                        <button id="stopYolo1" class="btn btn-danger" disabled><i class="fas fa-stop"></i> Stop</button>
                    </div>

                    <div class="video-container" style="flex: 1;">
                        <img id="pi5Stream" alt="Pi5 Stream" style="display: none; width: 100%; height: 100%; object-fit: contain;">
                        <canvas id="drawingCanvas1"></canvas>
                        <div id="placeholder1" style="color: rgba(255,255,255,0.6); text-align: center;">
                            <i class="fas fa-video" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>Click Connect to start Pi5 stream</p>
                        </div>
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 15px; overflow-y: auto; max-height: calc(100vh - 150px);">
    <h4><i class="fas fa-users"></i> Live Count</h4>
    <div id="liveCount1" style="margin-top: 1rem;">
        <p style="opacity: 0.7;">Start YOLO to see counts</p>
    </div>
    
    <!-- Zone Name Input Group (Hidden by default) -->
    <div id="zoneNameGroup1" style="display: none; margin-top: 2rem;">
        <label for="zoneNameInput1" style="color: white; display: block; margin-bottom: 0.5rem;">Zone Name:</label>
        <input type="text" id="zoneNameInput1" placeholder="Enter zone name" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; border-radius: 5px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
        
        <label for="zoneCapacityInput1" style="color: white; display: block; margin-bottom: 0.5rem; margin-top: 1rem;">Capacity Limit:</label>
        <input type="number" id="zoneCapacityInput1" placeholder="Max capacity" min="1" value="10" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; border-radius: 5px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
        
        <label for="zoneWarningInput1" style="color: white; display: block; margin-bottom: 0.5rem; margin-top: 1rem;">Warning Threshold:</label>
        <input type="number" id="zoneWarningInput1" placeholder="Warning at" min="1" value="8" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; border-radius: 5px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
        
        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
            <button class="btn btn-success btn-small" onclick="saveCurrentZone(1)" style="background: linear-gradient(135deg, #4CAF50, #45a049); padding: 0.5rem 1rem;">
                <i class="fas fa-save"></i> Save
            </button>
            <button class="btn btn-small" onclick="cancelCurrentZone(1)" style="padding: 0.5rem 1rem;">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>
    
    <div id="zoneInstructions1" style="margin-top: 1rem;">
        <p style="opacity: 0.8; font-size: 0.9rem;">
            <strong>Drawing Instructions:</strong><br>
            1. Connect to Pi5<br>
            2. Click "Draw Zone"<br>
            3. <strong>Left-click</strong> to add points<br>
            4. <strong>Right-click</strong> to finish<br>
            5. Enter zone details<br>
            6. Click "Save"<br>
            7. Click "Sync Zones"<br>
            8. Start YOLO
        </p>
    </div>
    
    <h4 style="margin-top: 2rem;"><i class="fas fa-list"></i> Zones</h4>
    <div id="zonesList1">
        <p style="opacity: 0.7; text-align: center;">No zones created</p>
    </div>
</div>
            </div>
        </div>
    </div>

    <!-- Camera 2 Modal (Local Video) -->
<!-- Camera 2 Modal (Local Video) -->
<div id="camera2Modal" class="camera-modal">
    <div style="width: 98%; height: 98%; margin: 1% auto; padding: 1rem; color: white;">
        <div style="display: flex; justify-content: space-between; padding-bottom: 1rem;">
            <h3><i class="fas fa-video"></i> Camera 2 - Local Video</h3>
            <button onclick="closeCameraModal(2)" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.5rem; width: 40px; height: 40px; border-radius: 50%; cursor: pointer;">&times;</button>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 320px; gap: 1rem; height: calc(100% - 60px);">
            <!-- LEFT COLUMN: Video Section -->
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <!-- Control Buttons -->
                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 15px; display: flex; gap: 1rem;">
                    <button id="selectVideoBtn2" class="btn"><i class="fas fa-folder-open"></i> Select Video</button>
                    <button id="drawZoneBtn2" class="btn" disabled><i class="fas fa-draw-polygon"></i> Draw Zone</button>
                    <button id="startProcessing2" class="btn" disabled><i class="fas fa-brain"></i> Start YOLO</button>
                    <button id="stopProcessing2" class="btn btn-danger" disabled><i class="fas fa-stop"></i> Stop YOLO</button>
                </div>

                <!-- Video Container -->
                <div class="video-container" style="flex: 1;">
                    <video id="recordedVideo" style="display: none; width: 100%; height: 100%; object-fit: contain;"></video>
                    <canvas id="drawingCanvas2"></canvas>
                    
                    <!-- Placeholder -->
                    <div id="placeholder2" style="color: rgba(255,255,255,0.6); text-align: center;">
                        <i class="fas fa-upload" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>Upload a video file to start</p>
                    </div>
                    
                    <!-- Video Preview Text -->
                    <div id="videoPreview2" style="display: none; color: rgba(255,255,255,0.8); text-align: center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 5; pointer-events: none;">
                        <i class="fas fa-play-circle" style="font-size: 4rem; margin-bottom: 1rem;"></i>
                        <p>Video loaded - Ready for zone drawing</p>
                    </div>
                    
                    <!-- Video Controls -->
                    <div class="video-preview-controls" id="videoControls2" style="display: none;">
                        <button class="play-pause-btn" id="playPauseBtn2">
                            <i class="fas fa-play"></i>
                        </button>
                        <div class="video-time" id="videoTime2">00:00 / 00:00</div>
                        <div class="video-scrubber" id="videoScrubber2">
                            <div class="video-progress" id="videoProgress2"></div>
                        </div>
                        <div class="volume-control">
                            <i class="fas fa-volume-up volume-icon" id="volumeIcon2"></i>
                            <div class="volume-slider" id="volumeSlider2">
                                <div class="volume-level" id="volumeLevel2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: Sidebar -->
            <div style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 15px; overflow-y: auto;">
                <h4><i class="fas fa-upload"></i> Video Upload</h4>
                <input type="file" id="videoFileInput" accept="video/*" style="display: none;">
                <div id="videoList2" style="margin-top: 1rem;"></div>
                
                <!-- Zone Name Input Group -->
                <div id="zoneNameGroup2" style="display: none; margin-top: 2rem;">
                    <label for="zoneNameInput2" style="color: white; display: block; margin-bottom: 0.5rem;">Zone Name:</label>
                    <input type="text" id="zoneNameInput2" placeholder="Enter zone name" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; border-radius: 5px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                    
                    <label for="zoneCapacityInput2" style="color: white; display: block; margin-bottom: 0.5rem; margin-top: 1rem;">Capacity Limit:</label>
                    <input type="number" id="zoneCapacityInput2" placeholder="Max capacity" min="1" value="10" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; border-radius: 5px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                    
                    <label for="zoneWarningInput2" style="color: white; display: block; margin-bottom: 0.5rem; margin-top: 1rem;">Warning Threshold:</label>
                    <input type="number" id="zoneWarningInput2" placeholder="Warning at" min="1" value="8" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; border-radius: 5px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                    
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                        <button class="btn btn-success btn-small" onclick="saveCurrentZone(2)" style="background: linear-gradient(135deg, #4CAF50, #45a049);">
                            <i class="fas fa-save"></i> Save
                        </button>
                        <button class="btn btn-small" onclick="cancelCurrentZone(2)">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
                
                <div id="zoneInstructions2" style="margin-top: 1rem;">
                    <p style="opacity: 0.8; font-size: 0.9rem;">
                        1. Load video<br>
                        2. Click "Draw Zone"<br>
                        3. <strong>Left-click</strong> to add points<br>
                        4. <strong>Right-click</strong> or <strong>double-click</strong> to finish<br>
                        5. Enter zone details<br>
                        6. Save zone<br>
                        7. Start YOLO
                    </p>
                </div>
                
                <h4 style="margin-top: 2rem;"><i class="fas fa-list"></i> Zones</h4>
                <div id="zonesList2">
                    <p style="opacity: 0.7; text-align: center;">No zones created</p>
                </div>
            </div>
        </div>
    </div>
</div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Complete JavaScript for Employee Dashboard - Part 1
const API_BASE = 'http://localhost:7000/api';
let socket = null;
let currentStream = null;
let selectedVideoId = null;
let cameras = {
    1: { isDrawing: false, currentPath: [], savedZones: [], canvas: null, ctx: null, video: null, processing: false, videoWidth: 1280, videoHeight: 720, canvasWidth: 0, canvasHeight: 0, zonesLoaded: false },
    2: { isDrawing: false, currentPath: [], savedZones: [], canvas: null, ctx: null, video: null, processing: false, videoLoaded: false, videoWidth: 0, videoHeight: 0, canvasWidth: 0, canvasHeight: 0, zonesLoaded: false }
};
const zoneColors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57', '#FF9FF3', '#54A0FF', '#5F27CD'];

window.addEventListener('load', () => {
    checkAuth(); loadUserInfo(); loadProfile(); initializeSocket(); setupEventListeners(); loadUploadedVideos();
    setTimeout(() => { setupVideoControls(); [1,2].forEach(id => updateCameraState(id, {zonesLoaded: false})); }, 500);
});

function checkAuth() {
    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    if (!token || user.role !== 'employee') { window.location.href = '/'; return false; }
    return true;
}

function loadUserInfo() {
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    document.getElementById('employee-name').textContent = `Welcome, ${user.full_name || user.username || 'Employee'}!`;
}

async function loadProfile() {
    try {
        const token = localStorage.getItem('token');
        if (!token) return;
        const response = await fetch(`${API_BASE}/profile`, { headers: { 'Authorization': `Bearer ${token}` } });
        if (response.ok) { displayProfile(await response.json()); }
        else if (response.status === 401) { showMessage('Session expired', 'error'); setTimeout(() => { localStorage.clear(); window.location.href = '/'; }, 2000); }
    } catch (error) { console.error('Error loading profile:', error); }
}

function displayProfile(p) {
    document.getElementById('profile-info').innerHTML = `
        <div class="info-item"><span class="info-label">Full Name:</span><span class="info-value">${p.full_name || 'Not set'}</span></div>
        <div class="info-item"><span class="info-label">Username:</span><span class="info-value">${p.username}</span></div>
        <div class="info-item"><span class="info-label">Email:</span><span class="info-value">${p.email || 'Not set'}</span></div>
        <div class="info-item"><span class="info-label">Department:</span><span class="info-value">${p.department || 'Not assigned'}</span></div>
        <div class="info-item"><span class="info-label">Role:</span><span class="info-value">${p.role || 'Employee'}</span></div>
    `;
}

function initializeSocket() {
    socket = io();
    socket.on('connect', () => console.log('Connected'));
    socket.on('live_camera_data', data => updateLiveStats(data));
    socket.on('camera_stats_update', data => data.cameraId === 2 && updateCamera2Stats(data));
    socket.on('yolo_process_status', status => { updateCameraYOLOStatus(status.cameraId, status); status.status === 'running' && showMessage(`YOLO active on Camera ${status.cameraId}`, 'success'); });
}

function setupEventListeners() {
    setupCameraEventListeners(1); setupCameraEventListeners(2);
    document.getElementById('videoFileInput').addEventListener('change', handleVideoUpload);
    const uploadArea = document.querySelector('.upload-area');
    if (uploadArea) {
        uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', e => { e.preventDefault(); uploadArea.classList.remove('dragover'); e.dataTransfer.files.length && handleVideoFile(e.dataTransfer.files[0]); });
    }
}

function setupCameraEventListeners(id) {
    const canvas = document.getElementById(`drawingCanvas${id}`);
    if (!canvas) return;
    cameras[id].canvas = canvas;
    cameras[id].ctx = canvas.getContext('2d');
    
    if (id === 1) {
        // Camera 1 (Pi5) buttons
        document.getElementById('startPi5')?.addEventListener('click', () => startWebcam(1));
        document.getElementById('stopPi5')?.addEventListener('click', () => stopWebcam(1));
        document.getElementById('drawZone1')?.addEventListener('click', () => toggleDrawMode(1));
        document.getElementById('syncZones1')?.addEventListener('click', () => syncZonesToPi5());
        document.getElementById('startYolo1')?.addEventListener('click', () => startYOLOProcessing(1));
        document.getElementById('stopYolo1')?.addEventListener('click', () => stopYOLOProcessing(1));
    } else {
        // Camera 2 (Video) buttons
        document.getElementById('selectVideoBtn2')?.addEventListener('click', () => {
            document.getElementById('videoFileInput').click();
        });
        document.getElementById('drawZoneBtn2')?.addEventListener('click', () => toggleDrawMode(2));
        document.getElementById('startProcessing2')?.addEventListener('click', () => startYOLOProcessing(2));
        document.getElementById('stopProcessing2')?.addEventListener('click', () => stopYOLOProcessing(2));
    }
    
    // UNIFIED DRAWING LOGIC (same for both cameras)
    canvas.addEventListener('click', e => handleCanvasClick(e, id));
    canvas.addEventListener('dblclick', e => {
        if (cameras[id].isDrawing && cameras[id].currentPath.length >= 3) {
            finishDrawing(e, id);
        }
    });
    
    // Right-click to finish (better than double-click)
    canvas.addEventListener('contextmenu', e => {
        if (!cameras[id].isDrawing) return;
        e.preventDefault();
        if (cameras[id].currentPath.length >= 3) {
            finishDrawing(e, id);
        } else {
            showMessage(`Need at least 3 points. Current: ${cameras[id].currentPath.length}`, 'warning');
        }
    });
    
    setTimeout(() => updateCanvasSize(id), 200);
    window.addEventListener('resize', () => setTimeout(() => updateCanvasSize(id), 100));
}
function openCamera1() { document.getElementById('camera1Modal').style.display = 'block'; document.body.style.overflow = 'hidden'; setTimeout(() => updateCanvasSize(1), 100); }
function openCamera2() { document.getElementById('camera2Modal').style.display = 'block'; document.body.style.overflow = 'hidden'; setTimeout(() => updateCanvasSize(2), 100); }

function closeCameraModal(id) {
    document.getElementById(`camera${id}Modal`).style.display = 'none';
    document.body.style.overflow = 'auto';
    if (cameras[id].isDrawing) { cameras[id].isDrawing = false; cameras[id].currentPath = []; updateDrawingMode(id); }
    id === 1 ? stopWebcam(1) : (cameras[2].video && !cameras[2].video.paused && cameras[2].video.pause(), showVideoControls(false));
    stopYOLOProcessing(id);
}

function updateCanvasSize(id) {
    const canvas = cameras[id].canvas;
    if (!canvas) return;
    
    const container = canvas.parentElement;
    const rect = container.getBoundingClientRect();
    
    if (rect.width <= 0 || rect.height <= 0) { 
        setTimeout(() => updateCanvasSize(id), 100); 
        return; 
    }
    
    // For Camera 1 (Pi5 stream), get dimensions from the image
    if (id === 1) {
        const img = document.getElementById('pi5Stream');
        if (img && img.complete && img.naturalWidth > 0) {
            // Use actual image dimensions
            const imgWidth = img.naturalWidth;
            const imgHeight = img.naturalHeight;
            
            // Calculate aspect ratio
            const aspectRatio = imgWidth / imgHeight;
            const containerAspect = rect.width / rect.height;
            
            let displayWidth, displayHeight;
            
            if (containerAspect > aspectRatio) {
                // Container is wider - fit to height
                displayHeight = rect.height;
                displayWidth = displayHeight * aspectRatio;
            } else {
                // Container is taller - fit to width
                displayWidth = rect.width;
                displayHeight = displayWidth / aspectRatio;
            }
            
            canvas.width = displayWidth;
            canvas.height = displayHeight;
            
            // Position canvas to overlay the image
            canvas.style.position = 'absolute';
            canvas.style.left = '50%';
            canvas.style.top = '50%';
            canvas.style.transform = 'translate(-50%, -50%)';
            
            updateCameraState(id, { 
                canvasWidth: displayWidth, 
                canvasHeight: displayHeight,
                videoWidth: imgWidth,
                videoHeight: imgHeight
            });
            
            console.log(`Camera 1 canvas sized: ${displayWidth}x${displayHeight} for image ${imgWidth}x${imgHeight}`);
            redrawCanvas(id);
            return;
        }
    }
    
    // For Camera 2 (video), use existing logic
    canvas.width = rect.width; 
    canvas.height = rect.height;
    updateCameraState(id, { canvasWidth: rect.width, canvasHeight: rect.height });
    redrawCanvas(id);
}

function updateCameraState(id, updates) {
    Object.assign(cameras[id], updates);
    const ready = checkCameraReadiness(id);
    cameras[id].isReady = ready.isFullyReady;
    updateProcessingButtonsWithState(id, ready);
    updateDrawButtonState(id, ready);
}

function checkCameraReadiness(id) {
    const c = cameras[id];
    
    let videoReady, hasValidDims;
    
    if (id === 1) {
        // Camera 1 (Pi5)
        videoReady = c.videoLoaded === true;
        hasValidDims = c.videoWidth > 0 && c.videoHeight > 0;
    } else {
        // Camera 2 (Video)
        videoReady = c.video && c.video.src && c.videoLoaded && c.video.readyState >= 2;
        hasValidDims = c.videoWidth > 0 && c.videoHeight > 0;
    }
    
    const hasZones = c.savedZones && c.savedZones.length > 0;
    const zonesLoaded = c.zonesLoaded === true;
    const canvasReady = c.canvasWidth > 0 && c.canvasHeight > 0;
    
    // For Camera 1 (Pi5), we don't need zonesLoaded or canvas dimensions
    // Just need: Pi5 connected + zones exist
    const isFullyReady = id === 1 ? 
        (videoReady && hasZones) : 
        (videoReady && hasValidDims && zonesLoaded && canvasReady && hasZones);
    
    const result = {
        isFullyReady,
        videoReady,
        hasZones,
        zonesLoaded,
        canvasReady,
        hasValidDims
    };
    
    console.log(`[READINESS CHECK] Camera ${id}:`, result);
    
    return result;
}


function updateDrawButtonState(id, ready) {
    const btn = document.getElementById(`drawZoneBtn${id}`);
    if (!btn) return;
    const canDraw = ready.videoReady && ready.hasValidDims && ready.canvasReady;
    if (cameras[id].isDrawing) {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-times"></i> Cancel Drawing';
        btn.classList.add('btn-danger');
    } else {
        btn.disabled = !canDraw;
        btn.innerHTML = '<i class="fas fa-draw-polygon"></i> Draw Zone';
        btn.classList.remove('btn-danger');
    }
}

async function startWebcam(id) {
    if (id !== 1) {
        showMessage('This function is only for Camera 1 (Pi5)', 'error');
        return;
    }
    
    try {
        showMessage('Connecting to Pi5...', 'info');
        
        const statusResponse = await fetch(`${API_BASE}/pi5-status`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        
        const statusData = await statusResponse.json();
        
        if (!statusData.available) {
            showMessage('Pi5 is not available. Check connection.', 'error');
            return;
        }
        
        const img = document.getElementById('pi5Stream');
        const placeholder = document.getElementById('placeholder1');
        
        if (!img) {
            showMessage('Pi5 stream element not found', 'error');
            return;
        }
        
        const streamUrl = `${API_BASE}/pi5-stream?t=${Date.now()}`;
        
        img.onload = function() {
            console.log('Pi5 stream loaded successfully');
            
            // FIXED: Get actual dimensions from loaded image
            const actualWidth = img.naturalWidth || img.width || 1280;
            const actualHeight = img.naturalHeight || img.height || 720;
            
            console.log(`Pi5 stream dimensions: ${actualWidth}x${actualHeight}`);
            
            updateCameraState(1, { 
                video: img, 
                videoWidth: actualWidth,
                videoHeight: actualHeight,
                videoLoaded: true 
            });
            
            img.style.display = 'block';
            placeholder.style.display = 'none';
            
            document.getElementById('startPi5').disabled = true;
            document.getElementById('stopPi5').disabled = false;
            document.getElementById('drawZone1').disabled = false;
            document.getElementById('syncZones1').disabled = false;
            
            // FIXED: Force canvas update after image is fully loaded
            setTimeout(() => { 
                updateCanvasSize(1);
                
                // FIXED: Ensure canvas is clickable
                const canvas = cameras[1].canvas;
                if (canvas) {
                    canvas.style.pointerEvents = 'auto';
                    console.log('Canvas 1 made clickable');
                }
                
                setTimeout(() => {
                    loadSavedZones(1).then(() => {
                        showMessage('Pi5 camera connected! Click "Draw Zone" to start.', 'success');
                    });
                }, 100); 
            }, 300);  // Increased delay for stability
        };
        
        img.onerror = function(e) {
            console.error('Failed to load Pi5 stream:', e);
            showMessage('Failed to connect to Pi5. Is it running?', 'error');
            img.style.display = 'none';
            placeholder.style.display = 'block';
            document.getElementById('startPi5').disabled = false;
            document.getElementById('stopPi5').disabled = true;
        };
        
        console.log('Loading Pi5 stream from:', streamUrl);
        img.src = streamUrl;
        cameras[1].video = img;
        
    } catch (e) { 
        console.error('Error connecting to Pi5:', e); 
        showMessage('Error connecting to Pi5: ' + e.message, 'error');
        document.getElementById('startPi5').disabled = false;
        document.getElementById('stopPi5').disabled = true;
    }
}
function stopWebcam(id) {
    if (id === 1) {
        // Stop Pi5 stream
        const img = document.getElementById('pi5Stream');
        const placeholder = document.getElementById('placeholder1');
        
        if (img) {
            img.src = ''; // Clear the stream
            img.style.display = 'none';
        }
        
        if (placeholder) {
            placeholder.style.display = 'block';
        }
        
        cameras[1].video = null;
        cameras[1].videoLoaded = false;
        
        document.getElementById('startPi5').disabled = false;
        document.getElementById('stopPi5').disabled = true;
        document.getElementById('drawZone1').disabled = true;
        
        cameras[1].isDrawing = false; 
        cameras[1].currentPath = []; 
        updateDrawingMode(1);
        
        showMessage('Pi5 disconnected', 'info');
    }
}

async function handleVideoUpload(e) { const f = e.target.files[0]; f && await handleVideoFile(f); }

async function handleVideoFile(file) {
    if (!file.type.startsWith('video/')) { showMessage('Please select a video file', 'error'); return; }
    if (file.size > 500 * 1024 * 1024) { showMessage('File too large (max 500MB)', 'error'); return; }
    const fd = new FormData(); fd.append('video', file);
    try {
        showMessage('Uploading...', 'info');
        const res = await fetch(`${API_BASE}/upload-video`, { method: 'POST', headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }, body: fd });
        if (res.ok) { const r = await res.json(); showMessage('Uploaded!', 'success'); loadUploadedVideos(); selectVideo(r.video.id, r.video.original_name, r.video.filename); }
        else { const e = await res.json(); showMessage(`Failed: ${e.error}`, 'error'); }
    } catch (e) { console.error(e); showMessage('Upload error', 'error'); }
}

async function loadUploadedVideos() {
    try {
        const res = await fetch(`${API_BASE}/videos`, { headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
        res.ok && displayUploadedVideos(await res.json());
    } catch (e) { console.error(e); }
}

function displayUploadedVideos(vids) {
    const list = document.getElementById('videoList2');
    if (!vids.length) { list.innerHTML = '<p style="text-align:center;opacity:0.7">No videos uploaded</p>'; return; }
    list.innerHTML = vids.map(v => `<div class="video-item" onclick="selectVideo(${v.id},'${v.original_name}','${v.filename}')" data-video-id="${v.id}"><div><div style="font-weight:600">${v.original_name}</div><small>${(v.size/1024/1024).toFixed(1)} MB</small></div><i class="fas fa-play-circle"></i></div>`).join('');
}

async function selectVideo(id, name, file) {
    try {
        const res = await fetch(`${API_BASE}/set-current-video`, { method: 'POST', headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ videoId: id }) });
        if (res.ok) {
            selectedVideoId = id;
            document.querySelectorAll('.video-item').forEach(i => i.classList.remove('selected'));
            const sel = document.querySelector(`[data-video-id="${id}"]`);
            sel && sel.classList.add('selected');
            await loadVideoPreview(file, name);
        } else { const e = await res.json(); showMessage(`Error: ${e.error}`, 'error'); }
    } catch (e) { console.error(e); showMessage('Error selecting video', 'error'); }
}

async function loadVideoPreview(file, name) {
    const video = document.getElementById('recordedVideo');
    const ph = document.getElementById('placeholder2');
    updateCameraState(2, { videoLoaded: false, videoWidth: null, videoHeight: null });
    showVideoControls(false);
    
    try {
        const token = localStorage.getItem('token');
        
        // Fetch the video with authorization header
        console.log('Fetching video with ID:', selectedVideoId);
        const response = await fetch(`${API_BASE}/video/${selectedVideoId}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Convert response to blob
        const blob = await response.blob();
        console.log('Video blob received, size:', blob.size, 'type:', blob.type);
        
        // Create object URL from blob
        const blobUrl = URL.createObjectURL(blob);
        
        return new Promise((resolve, reject) => {
            video.onloadedmetadata = () => {
                console.log('Video metadata loaded');
                video.oncanplay = () => {
                    console.log('Video can play, dimensions:', video.videoWidth, 'x', video.videoHeight);
                    
                    updateCameraState(2, { 
                        video, 
                        videoWidth: video.videoWidth, 
                        videoHeight: video.videoHeight, 
                        videoLoaded: true 
                    });
                    
                    video.style.display = 'block'; 
                    ph.style.display = 'none'; 
                    
                    const preview = document.getElementById('videoPreview2');
                    if (preview) preview.style.display = 'block';
                    
                    setTimeout(() => { 
                        updateCanvasSize(2); 
                        setTimeout(() => {
                            loadSavedZones(2).then(() => { 
                                showVideoControls(true); 
                                showMessage(`Loaded: ${video.videoWidth}x${video.videoHeight}`, 'success'); 
                                 const canvas = document.getElementById('drawingCanvas2');
        if (canvas) {
            // Remove old listeners (if any)
            const newCanvas = canvas.cloneNode(true);
            canvas.parentNode.replaceChild(newCanvas, canvas);
            cameras[2].canvas = newCanvas;
            cameras[2].ctx = newCanvas.getContext('2d');
            
            // Re-attach click listener
            newCanvas.addEventListener('click', (e) => {
                console.log('Canvas 2 clicked!');
                handleCanvasClick(e, 2);
            });
            
            // Re-attach double-click listener
            newCanvas.addEventListener('dblclick', (e) => {
                console.log('Canvas 2 double-clicked!');
                if (cameras[2].isDrawing && cameras[2].currentPath.length >= 3) {
                    finishDrawing(e, 2);
                }
            });
            
            console.log('Canvas 2 event listeners re-attached');
        }
        
                                resolve(); 
                            });
                        }, 100); 
                    }, 200);
                };
                
                if (video.readyState >= 3) {
                    video.oncanplay();
                }
            };
            
            video.onerror = (e) => { 
                console.error('Video load error:', e);
                updateCameraState(2, { videoLoaded: false }); 
                showMessage('Video load error - file may be corrupted', 'error'); 
                URL.revokeObjectURL(blobUrl); // Clean up
                reject(new Error('Failed to load video')); 
            };
            
            video.src = blobUrl; 
            video.load();
        });
        
    } catch (error) {
        console.error('Error fetching video:', error);
        updateCameraState(2, { videoLoaded: false });
        showMessage('Failed to fetch video - please check your connection', 'error');
        throw error;
    }
}

function setupVideoControls() {
    const video = document.getElementById('recordedVideo');
    const playBtn = document.getElementById('playPauseBtn2');
    const timeEl = document.getElementById('videoTime2');
    const scrubber = document.getElementById('videoScrubber2');
    const progress = document.getElementById('videoProgress2');
    const volIcon = document.getElementById('volumeIcon2');
    const volSlider = document.getElementById('volumeSlider2');
    const volLevel = document.getElementById('volumeLevel2');
    if (!video || !playBtn) return;
    cameras[2].video = video; video.volume = 0.5; volLevel && (volLevel.style.width = '50%');
    
    playBtn.addEventListener('click', e => { e.preventDefault(); e.stopPropagation(); video.paused ? video.play().then(() => playBtn.innerHTML = '<i class="fas fa-pause"></i>').catch(e => showMessage('Play error', 'error')) : (video.pause(), playBtn.innerHTML = '<i class="fas fa-play"></i>'); });
    volSlider && volSlider.addEventListener('click', e => { e.preventDefault(); e.stopPropagation(); const r = volSlider.getBoundingClientRect(); const p = Math.max(0, Math.min(1, (e.clientX - r.left) / r.width)); video.volume = p; volLevel && (volLevel.style.width = `${p*100}%`); updateVolIcon(); });
    volIcon && volIcon.addEventListener('click', e => { e.preventDefault(); e.stopPropagation(); if (video.volume > 0) { video.dataset.previousVolume = video.volume; video.volume = 0; volLevel && (volLevel.style.width = '0%'); } else { video.volume = video.dataset.previousVolume || 0.5; volLevel && (volLevel.style.width = `${video.volume*100}%`); } updateVolIcon(); });
    
    function updateVolIcon() { if (!volIcon) return; volIcon.className = video.volume === 0 ? 'fas fa-volume-mute volume-icon' : video.volume < 0.5 ? 'fas fa-volume-down volume-icon' : 'fas fa-volume-up volume-icon'; }
    
    video.addEventListener('timeupdate', () => { if (video.duration && isFinite(video.duration)) { timeEl && (timeEl.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`); progress && (progress.style.width = `${(video.currentTime/video.duration)*100}%`); } });
    video.addEventListener('ended', () => playBtn.innerHTML = '<i class="fas fa-play"></i>');
    scrubber && scrubber.addEventListener('click', e => { e.preventDefault(); e.stopPropagation(); if (video.duration && isFinite(video.duration)) { const r = scrubber.getBoundingClientRect(); video.currentTime = Math.max(0, Math.min(1, (e.clientX - r.left) / r.width)) * video.duration; } });
    video.addEventListener('loadedmetadata', () => { if (video.duration && isFinite(video.duration)) { timeEl && (timeEl.textContent = `00:00 / ${formatTime(video.duration)}`); playBtn.innerHTML = '<i class="fas fa-play"></i>'; setTimeout(() => updateCanvasSize(2), 100); cameras[2].videoLoaded = true; setTimeout(() => !cameras[2].isDrawing && showVideoControls(true), 200); } });
    video.addEventListener('click', e => { if (!cameras[2].isDrawing) { e.preventDefault(); e.stopPropagation(); showVideoControls(true); video.paused ? video.play().then(() => playBtn.innerHTML = '<i class="fas fa-pause"></i>').catch(console.error) : (video.pause(), playBtn.innerHTML = '<i class="fas fa-play"></i>'); } });
}

function showVideoControls(vis) {
    const ctrl = document.getElementById('videoControls2');
    if (!ctrl) return;
if (vis && cameras[2].videoLoaded && !cameras[2].isDrawing) {
        ctrl.style.display = 'flex';
        ctrl.classList.add('visible');
        cameras[2].controlsVisible = true;
        
        // Force visibility
        ctrl.style.opacity = '1';
        ctrl.style.pointerEvents = 'auto';
    } else if (!cameras[2].isDrawing) {
        ctrl.style.display = 'none';
        ctrl.classList.remove('visible');
        cameras[2].controlsVisible = false;
    }
}

function formatTime(s) {
    if (isNaN(s) || !isFinite(s) || s < 0) return '00:00';
    const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = Math.floor(s%60);
    return h > 0 ? `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}` : `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
}

function toggleDrawMode(id) {
    console.log(`Toggling draw mode for camera ${id}`);

    if (!cameras[id].isDrawing) {
        // Validate before entering drawing mode
        if (id === 1 && !cameras[1].videoLoaded) {
            showMessage('Please connect to Pi5 first', 'error');
            return;
        }
        if (id === 2 && !cameras[2].videoLoaded) {
            showMessage('Please load a video first', 'error');
            return;
        }
        if (!cameras[id].canvasWidth || !cameras[id].canvasHeight) {
            console.warn('Canvas not sized, attempting to resize...');
            updateCanvasSize(id);
            setTimeout(() => toggleDrawMode(id), 100);
            return;
        }
    }

    cameras[id].isDrawing = !cameras[id].isDrawing;
    cameras[id].currentPath = [];

    const canvas = cameras[id].canvas;
    const btn = document.getElementById(id === 1 ? 'drawZone1' : 'drawZoneBtn2');
    
    if (cameras[id].isDrawing) {
        canvas.style.pointerEvents = 'auto';
        canvas.classList.add('drawing-active');
        if (btn) {
            btn.innerHTML = '<i class="fas fa-times"></i> Cancel Drawing';
            btn.classList.add('btn-danger');
        }
        showMessage(`Drawing mode ON. Left-click to add points, right-click to finish.`, 'info');
    } else {
        canvas.style.pointerEvents = 'none';
        canvas.classList.remove('drawing-active');
        if (btn) {
            btn.innerHTML = '<i class="fas fa-draw-polygon"></i> Draw Zone';
            btn.classList.remove('btn-danger');
        }
    }

    redrawCanvas(id);

    if (id === 2) {
        handleCamera2DrawingWorkflow(cameras[id].isDrawing);
    }
}
function updateDrawingMode(id) {
    const mode = document.getElementById(`drawingMode${id}`);
    const btn = document.getElementById(`drawZoneBtn${id}`);
    const canvas = cameras[id].canvas;
    if (cameras[id].isDrawing) {
        
        btn.innerHTML = '<i class="fas fa-times"></i> Cancel Drawing';
        btn.classList.add('btn-danger');
        canvas.classList.add('drawing-active');
        showMessage(`Drawing mode on Camera ${id}. Click points, double-click to finish`, 'info');
    } else {
        
        btn.innerHTML = '<i class="fas fa-draw-polygon"></i> Draw Zone';
        btn.classList.remove('btn-danger');
        canvas.classList.remove('drawing-active');
    }
}

function handleCanvasClick(e, id) {
    if (!cameras[id].isDrawing) return;
    if (!cameras[id].videoWidth || !cameras[id].videoHeight) { 
        showMessage('Video dimensions unavailable', 'error'); 
        return; 
    }
    
    e.preventDefault(); 
    e.stopPropagation();
    
    const canvas = cameras[id].canvas;
    const rect = canvas.getBoundingClientRect();
    const canvasX = e.clientX - rect.left;
    const canvasY = e.clientY - rect.top;
    const videoX = (canvasX / cameras[id].canvasWidth) * cameras[id].videoWidth;
    const videoY = (canvasY / cameras[id].canvasHeight) * cameras[id].videoHeight;
    
    cameras[id].currentPath.push({ 
        x: Math.round(videoX), 
        y: Math.round(videoY) 
    });
    
    redrawCanvas(id);
    
    const pointCount = cameras[id].currentPath.length;
    
    if (pointCount === 1) {
        showMessage('Point 1 added. Keep clicking to add more points.', 'info');
    } else if (pointCount === 2) {
        showMessage('Point 2 added. Need at least 1 more point.', 'info');
    } else if (pointCount === 3) {
        showMessage('Point 3 added. Right-click or double-click to finish.', 'success');
    } else {
        showMessage(`Point ${pointCount} added. Right-click or double-click to finish.`, 'info');
    }
}

function finishDrawing(e, id) {
    if (!cameras[id].isDrawing || cameras[id].currentPath.length < 3) {
        console.log('Cannot finish drawing:', {
            isDrawing: cameras[id].isDrawing,
            points: cameras[id].currentPath.length
        });
        return;
    }
    
    e.preventDefault();
    e.stopPropagation();
    
    console.log(`Finishing zone for camera ${id} with ${cameras[id].currentPath.length} points`);
    
    // Show zone configuration form
    document.getElementById(`zoneNameGroup${id}`).style.display = 'block';
    document.getElementById(`zoneInstructions${id}`).style.display = 'none';
    document.getElementById(`zoneNameInput${id}`).focus();
    
    // Exit drawing mode
    cameras[id].isDrawing = false;
    updateDrawingMode(id);
    
    // Redraw canvas to show completed zone
    redrawCanvas(id);
    
    if (id === 2) {
        handleCamera2DrawingWorkflow(false);
    }
    
    showMessage('Zone completed! Enter details and save.', 'success');
}

function handleCamera2DrawingWorkflow(entering) {
    const video = cameras[2].video;
    if (entering) {
        console.log('Entering drawing mode');
        showVideoControls(false);
        video && !video.paused && showMessage('Video playing in draw mode. Controls blocked.', 'info');
    } else {
        console.log('Exiting drawing mode');
        cameras[2].videoLoaded && setTimeout(() => showVideoControls(true), 100);
        showMessage('Drawing mode exited. Controls restored.', 'success');
    }
}
async function saveCurrentZone(id) {
    const name = document.getElementById(`zoneNameInput${id}`).value.trim();
    const cap = parseInt(document.getElementById(`zoneCapacityInput${id}`).value);
    const warn = parseInt(document.getElementById(`zoneWarningInput${id}`).value);
    
    if (!name) { 
        showMessage('Enter zone name', 'error'); 
        return; 
    }
    if (!cap || cap <= 0) { 
        showMessage('Enter valid capacity', 'error'); 
        return; 
    }
    if (!warn || warn <= 0) { 
        showMessage('Enter valid warning threshold', 'error'); 
        return; 
    }
    if (warn >= cap) { 
        showMessage('Warning must be less than capacity', 'error'); 
        return; 
    }
    if (cameras[id].currentPath.length < 3) { 
        showMessage('Need at least 3 points', 'error'); 
        return; 
    }
    
    try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        // Convert coordinates to array format
        const coordinatesArray = cameras[id].currentPath.map(p => [p.x, p.y]);
        
        console.log(`Saving zone for camera ${id}:`, name, coordinatesArray);
        
        const data = { 
            name, 
            coordinates: JSON.stringify(coordinatesArray),
            camera_id: id, 
            user_id: user.id, 
            capacity_limit: cap, 
            warning_threshold: warn, 
            alert_color: '#4ecdc4', 
            video_width: cameras[id].videoWidth, 
            video_height: cameras[id].videoHeight, 
            canvas_width: cameras[id].canvasWidth, 
            canvas_height: cameras[id].canvasHeight 
        };
        
        const res = await fetch(`${API_BASE}/zones`, { 
            method: 'POST', 
            headers: { 
                'Authorization': `Bearer ${localStorage.getItem('token')}`, 
                'Content-Type': 'application/json' 
            }, 
            body: JSON.stringify(data) 
        });
        
        if (res.ok) {
            const result = await res.json();
            console.log('Zone saved successfully:', result);
            
            cameras[id].currentPath = [];
            document.getElementById(`zoneNameInput${id}`).value = '';
            document.getElementById(`zoneCapacityInput${id}`).value = '10';
            document.getElementById(`zoneWarningInput${id}`).value = '8';
            document.getElementById(`zoneNameGroup${id}`).style.display = 'none';
            document.getElementById(`zoneInstructions${id}`).style.display = 'block';
            
            await loadSavedZones(id);
            redrawCanvas(id);
            
            showMessage(`Zone "${name}" saved successfully!`, 'success');
            
            // FOR CAMERA 1: Auto-prompt to sync
            if (id === 1) {
                setTimeout(() => {
                    if (confirm('Zone saved! Sync to Pi5 now?')) {
                        syncZonesToPi5();
                    }
                }, 500);
            }
            
            socket && socket.emit('update_zones', { 
                cameraId: id, 
                zones: cameras[id].savedZones 
            });
        } else { 
            const error = await res.json(); 
            console.error('Save error:', error);
            showMessage(`Error: ${error.error}`, 'error'); 
        }
    } catch (e) { 
        console.error('Exception saving zone:', e); 
        showMessage('Save error: ' + e.message, 'error'); 
    }
}
function cancelCurrentZone(id) {
    cameras[id].currentPath = [];
    document.getElementById(`zoneNameInput${id}`).value = '';
    document.getElementById(`zoneCapacityInput${id}`).value = '10';
    document.getElementById(`zoneWarningInput${id}`).value = '8';
    document.getElementById(`zoneNameGroup${id}`).style.display = 'none';
    document.getElementById(`zoneInstructions${id}`).style.display = 'block';
    redrawCanvas(id);
    
    if (id === 2 && cameras[2].videoLoaded) {
        setTimeout(() => showVideoControls(true), 100);
    }
    
    showMessage('Zone cancelled', 'info');
}

async function loadSavedZones(id) {
    updateCameraState(id, { zonesLoaded: false });
    
    try {
        console.log(`Loading zones for camera ${id}...`);
        
        const res = await fetch(`${API_BASE}/zones?camera_id=${id}`, { 
            headers: { 
                'Authorization': `Bearer ${localStorage.getItem('token')}` 
            } 
        });
        
        if (res.ok) {
            const dbZones = await res.json();
            console.log('Zones loaded from DB:', dbZones);
            
            const mapped = (Array.isArray(dbZones) ? dbZones : []).map((z, i) => {
                let coords = [];
                
                try { 
                    const parsed = typeof z.coordinates === 'string' ? 
                        JSON.parse(z.coordinates) : z.coordinates;
                    
                    // FIXED: Handle both formats
                    // Format 1: [[x,y], [x,y], ...] - array of arrays
                    // Format 2: [{x:1, y:2}, {x:3, y:4}, ...] - array of objects
                    
                    if (Array.isArray(parsed)) {
                        coords = parsed.map(p => {
                            if (Array.isArray(p)) {
                                // Format: [[x, y], [x, y]]
                                return { x: p[0], y: p[1] };
                            } else if (p.x !== undefined && p.y !== undefined) {
                                // Format: [{x, y}, {x, y}]
                                return { x: p.x, y: p.y };
                            }
                            return null;
                        }).filter(p => p !== null);
                    }
                    
                    console.log(`Zone ${z.id} "${z.name}": ${coords.length} points`);
                }
                catch (e) { 
                    console.error(`Parse error for zone ${z.id}:`, e); 
                }
                
                return { 
                    id: z.id, 
                    name: z.name, 
                    points: coords, 
                    color: zoneColors[i % zoneColors.length], 
                    capacity_limit: z.capacity_limit || 10, 
                    warning_threshold: z.warning_threshold || 8,
                    video_width: z.video_width,
                    video_height: z.video_height
                };
            });
            
            console.log(`Mapped ${mapped.length} zones for camera ${id}`);
            
            updateCameraState(id, { savedZones: mapped, zonesLoaded: true });
            updateZonesList(id); 
            redrawCanvas(id);
            
            showMessage(`Loaded ${mapped.length} zone(s) for Camera ${id}`, 'success');
        } else { 
            console.warn('Failed to load zones:', res.status);
            updateCameraState(id, { savedZones: [], zonesLoaded: true }); 
            updateZonesList(id);
        }
    } catch (e) { 
        console.error('Error loading zones:', e); 
        updateCameraState(id, { savedZones: [], zonesLoaded: true }); 
        updateZonesList(id);
    }
}

async function syncZonesToPi5() {
    try {
        // Load zones first if not loaded
        if (!cameras[1].zonesLoaded || cameras[1].savedZones.length === 0) {
            await loadSavedZones(1);
        }
        
        if (cameras[1].savedZones.length === 0) {
            showMessage('No zones to sync. Create zones first for Camera 1.', 'warning');
            return;
        }
        
        showMessage(`Syncing ${cameras[1].savedZones.length} zone(s) to Pi5...`, 'info');
        
        const btn = document.getElementById('syncZones1');
        if (btn) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
            btn.disabled = true;
        }
        
        const response = await fetch(`${API_BASE}/zones/sync-to-pi5`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ cameraId: 1 })
        });
        
        const result = await response.json();
        
        if (btn) {
            btn.innerHTML = '<i class="fas fa-sync"></i> Sync Zones';
            btn.disabled = false;
        }
        
        if (response.ok && result.success) {
            showMessage(` Synced ${result.zones_synced} zone(s) to Pi5!`, 'success');
            console.log('Synced zones:', result.zone_names);
        } else {
            showMessage(result.message || 'Failed to sync zones', 'error');
        }
        
    } catch (error) {
        console.error('Sync error:', error);
        showMessage('Error syncing to Pi5: ' + error.message, 'error');
        const btn = document.getElementById('syncZones1');
        if (btn) {
            btn.innerHTML = '<i class="fas fa-sync"></i> Sync Zones';
            btn.disabled = false;
        }
    }
}

function updateZonesList(id) {
    const list = document.getElementById(`zonesList${id}`);
    
    if (!list) {
        console.error(`Zone list not found for camera ${id}`);
        return;
    }
    
    if (!cameras[id].savedZones || cameras[id].savedZones.length === 0) { 
        list.innerHTML = '<p style="opacity:0.7;text-align:center;padding:1rem;">No zones created</p>'; 
        return; 
    }
    
    list.innerHTML = cameras[id].savedZones.map(z => `
        <div style="display:flex; justify-content:space-between; align-items:center; padding:0.75rem; margin-bottom:0.5rem; background:rgba(255,255,255,0.1); border-radius:8px; border-left:4px solid ${z.color};">
            <div style="flex:1;">
                <div style="font-weight:600; margin-bottom:0.25rem;">${z.name}</div>
                <small style="opacity:0.7;">Cap: ${z.capacity_limit} | Warn: ${z.warning_threshold}</small>
            </div>
            <button class="btn btn-danger btn-small" onclick="deleteZone(${id},${z.id})" style="padding:0.25rem 0.5rem;">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `).join('');
    
    console.log(`Updated zones list for camera ${id}: ${cameras[id].savedZones.length} zones`);
}
async function deleteZone(id, zoneId) {
    if (!confirm('Delete this zone?')) return;
    try {
        const res = await fetch(`${API_BASE}/zones/${zoneId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
        if (res.ok) { loadSavedZones(id); showMessage('Zone deleted', 'info'); socket && socket.emit('update_zones', { cameraId: id, zones: cameras[id].savedZones.filter(z => z.id !== zoneId) }); }
        else { const e = await res.json(); showMessage(`Error: ${e.error}`, 'error'); }
    } catch (e) { console.error(e); showMessage('Delete error', 'error'); }
}

function redrawCanvas(id) {
    const ctx = cameras[id].ctx, canvas = cameras[id].canvas;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    cameras[id].savedZones.forEach(z => {
        if (z.points && z.points.length) {
            const pts = cameras[id].videoWidth && cameras[id].canvasWidth ? z.points.map(p => ({ x: (p.x/cameras[id].videoWidth)*cameras[id].canvasWidth, y: (p.y/cameras[id].videoHeight)*cameras[id].canvasHeight })) : z.points;
            drawPolygon(ctx, pts, z.color, z.name, false);
        }
    });
    if (cameras[id].currentPath.length) {
        const pts = cameras[id].videoWidth && cameras[id].canvasWidth ? cameras[id].currentPath.map(p => ({ x: (p.x/cameras[id].videoWidth)*cameras[id].canvasWidth, y: (p.y/cameras[id].videoHeight)*cameras[id].canvasHeight })) : cameras[id].currentPath;
        drawPolygon(ctx, pts, '#FFFF00', 'Drawing...', true);
    }
}
// Complete JavaScript for Employee Dashboard - Part 2 (continuation)

function drawPolygon(ctx, pts, color, label, isDrawing) {
    if (!pts || !pts.length) return;
    ctx.save();
    ctx.fillStyle = isDrawing ? 'rgba(255,255,0,0.2)' : hexToRgba(color, 0.25);
    ctx.strokeStyle = color;
    ctx.lineWidth = 3;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.beginPath();
    ctx.moveTo(pts[0].x, pts[0].y);
    for (let i = 1; i < pts.length; i++) ctx.lineTo(pts[i].x, pts[i].y);
    if (!isDrawing) { ctx.closePath(); ctx.fill(); }
    ctx.stroke();
    pts.forEach((p, i) => {
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(p.x, p.y, 6, 0, 2 * Math.PI);
        ctx.fill();
        if (isDrawing) {
            ctx.fillStyle = '#000';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(i + 1, p.x, p.y - 10);
        }
    });
    if (pts.length && label && !isDrawing) {
        const cx = pts.reduce((s, p) => s + p.x, 0) / pts.length;
        const cy = pts.reduce((s, p) => s + p.y, 0) / pts.length;
        ctx.fillStyle = '#000';
        ctx.font = 'bold 14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(label, cx, cy + 5);
        ctx.fillStyle = '#FFF';
        ctx.fillText(label, cx - 1, cy + 4);
    }
    ctx.restore();
}

function hexToRgba(hex, alpha) {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return `rgba(${r},${g},${b},${alpha})`;
}

async function startYOLOProcessing(id) {
    console.log(`[YOLO START] Attempting to start YOLO for camera ${id}`);
    console.log(`[YOLO START] Current state:`, {
        zones: cameras[id].savedZones?.length || 0,
        videoLoaded: cameras[id].videoLoaded,
        processing: cameras[id].processing,
        zonesLoaded: cameras[id].zonesLoaded
    });
    
    // Validation: Check zones exist
    if (!cameras[id].savedZones || cameras[id].savedZones.length === 0) { 
        showMessage('Create and save zones first', 'error'); 
        console.error('[YOLO START] No zones available');
        return; 
    }
    
    // Camera-specific validation
    if (id === 1) {
        // Pi5 validation
        if (!cameras[1].videoLoaded) {
            showMessage('Connect to Pi5 first', 'error');
            console.error('[YOLO START] Pi5 not connected');
            return;
        }
        
        console.log(`[YOLO START]  Camera 1 ready. Zones: ${cameras[1].savedZones.length}`);
        
    } else if (id === 2) {
        // Video validation
        if (!cameras[2].videoLoaded) { 
            showMessage('Load video first', 'error'); 
            console.error('[YOLO START] Video not loaded');
            return; 
        }
        
        console.log(`[YOLO START]  Camera 2 ready. Zones: ${cameras[2].savedZones.length}`);
    }
    
    try {
        // Update button to show loading state
        const btn = document.getElementById(id === 1 ? 'startYolo1' : 'startProcessing2');
        const stopBtn = document.getElementById(id === 1 ? 'stopYolo1' : 'stopProcessing2');
        
        if (btn) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
            btn.disabled = true;
        }
        
        // CAMERA 1 (Pi5) - Special handling
        if (id === 1) {
            console.log('[YOLO START] Camera 1: Syncing zones to Pi5...');
            showMessage('Syncing zones to Pi5...', 'info');
            
            // Step 1: Sync zones to Pi5
            const syncResponse = await fetch(`${API_BASE}/zones/sync-to-pi5`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ cameraId: 1 })
            });
            
            const syncResult = await syncResponse.json();
            console.log('[YOLO START] Sync result:', syncResult);
            
            if (!syncResponse.ok || !syncResult.success) {
                throw new Error(`Zone sync failed: ${syncResult.message || 'Unknown error'}`);
            }
            
            console.log(`[YOLO START]  Synced ${syncResult.zones_synced} zones to Pi5`);
            
            // Wait for Pi5 to process zones
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            console.log('[YOLO START] Camera 1: Starting Pi5 processing...');
            showMessage('Starting Pi5 YOLO processing...', 'info');
            
            // Step 2: Start Pi5 YOLO processing
            const startResponse = await fetch(`${API_BASE}/pi5/start-processing`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                }
            });
            
            const startResult = await startResponse.json();
            console.log('[YOLO START] Pi5 start result:', startResult);
            
            if (!startResponse.ok || !startResult.success) {
                throw new Error(`Pi5 start failed: ${startResult.error || 'Unknown error'}`);
            }
            
            // Success!
            cameras[1].processing = true;
            cameras[1].yoloActive = true;
            
            if (btn) {
                btn.innerHTML = '<i class="fas fa-brain"></i> YOLO Running';
                btn.disabled = true;
            }
            if (stopBtn) {
                stopBtn.disabled = false;
            }
            
            showMessage(' Pi5 YOLO started successfully!', 'success');
            console.log('[YOLO START]  Camera 1 YOLO started successfully');
            
            return;
        }
        
        // CAMERA 2 (Local Video) - Original logic
        const data = { 
            cameraId: id, 
            cameraType: 'video',
            cameraIndex: undefined 
        };
        
        console.log('[YOLO START] Starting local YOLO with data:', data);
        
        const res = await fetch(`${API_BASE}/start-yolo`, { 
            method: 'POST', 
            headers: { 
                'Authorization': `Bearer ${localStorage.getItem('token')}`, 
                'Content-Type': 'application/json' 
            }, 
            body: JSON.stringify(data) 
        });
        
        const result = await res.json();
        console.log('[YOLO START] Start result:', result);
        
        if (res.ok) {
            cameras[id].processing = true;
            cameras[id].yoloActive = true;
            
            if (btn) {
                btn.innerHTML = '<i class="fas fa-brain"></i> YOLO Running';
                btn.disabled = true;
            }
            if (stopBtn) {
                stopBtn.disabled = false;
            }
            
            showMessage(` YOLO started for Camera ${id}`, 'success');
            console.log(`[YOLO START]  Camera ${id} YOLO started successfully`);
        } else {
            throw new Error(result.error || 'Failed to start YOLO');
        }
        
    } catch (error) {
        console.error('[YOLO START]  Error:', error);
        
        // Reset button on error
        const btn = document.getElementById(id === 1 ? 'startYolo1' : 'startProcessing2');
        if (btn) {
            btn.innerHTML = '<i class="fas fa-brain"></i> Start YOLO';
            btn.disabled = false;
        }
        
        showMessage(`YOLO start failed: ${error.message}`, 'error');
    }
}

async function stopYOLOProcessing(id) {
    console.log(`[YOLO STOP] Stopping YOLO for camera ${id}`);
    
    try {
        const btn = document.getElementById(id === 1 ? 'stopYolo1' : 'stopProcessing2');
        const startBtn = document.getElementById(id === 1 ? 'startYolo1' : 'startProcessing2');
        
        if (btn) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Stopping...';
            btn.disabled = true;
        }
        
        let res;
        
        if (id === 1) {
            // Pi5 stop
            console.log('[YOLO STOP] Stopping Pi5 processing...');
            res = await fetch(`${API_BASE}/pi5/stop-processing`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                }
            });
        } else {
            // Local YOLO stop
            res = await fetch(`${API_BASE}/stop-yolo`, { 
                method: 'POST', 
                headers: { 
                    'Authorization': `Bearer ${localStorage.getItem('token')}`, 
                    'Content-Type': 'application/json' 
                }, 
                body: JSON.stringify({ cameraId: id }) 
            });
        }
        
        const result = await res.json();
        console.log('[YOLO STOP] Stop result:', result);
        
        if (res.ok) {
            cameras[id].processing = false;
            cameras[id].yoloActive = false;
            
            if (btn) {
                btn.innerHTML = '<i class="fas fa-stop"></i> Stop YOLO';
                btn.disabled = true;
            }
            if (startBtn) {
                startBtn.innerHTML = '<i class="fas fa-brain"></i> Start YOLO';
                startBtn.disabled = false;
            }
            
            showMessage(` YOLO stopped for Camera ${id}`, 'info');
            console.log(`[YOLO STOP]  Camera ${id} YOLO stopped`);
        } else {
            throw new Error(result.error || 'Failed to stop YOLO');
        }
        
    } catch (error) {
        console.error('[YOLO STOP] Error:', error);
        
        const btn = document.getElementById(id === 1 ? 'stopYolo1' : 'stopProcessing2');
        if (btn) {
            btn.innerHTML = '<i class="fas fa-stop"></i> Stop YOLO';
            btn.disabled = false;
        }
        
        showMessage(`Stop failed: ${error.message}`, 'error');
    }
}

function updateLiveStats(data) {
    console.log('Updating live stats:', data);
    if (data.camera_id === 1) updateCamera1Stats(data);
    else if (data.camera_id === 2) updateCamera2Stats(data);
}

function updateCamera1Stats(data) {
    console.log('Camera 1 stats:', data);
    if (data.total_count !== undefined) {
        const container = document.querySelector('#camera1Modal .video-container');
        if (container) {
            let overlay = container.querySelector('.live-stats-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.className = 'live-stats-overlay';
                overlay.style.cssText = 'position:absolute;top:60px;left:15px;background:rgba(0,0,0,0.8);color:white;padding:0.5rem 1rem;border-radius:10px;font-size:0.9rem;z-index:25';
                container.appendChild(overlay);
            }
            let html = `<strong>Live: ${data.total_count || 0}</strong>`;
            if (data.zone_counts && Object.keys(data.zone_counts).length) {
                html += '<br><small>';
                for (const [name, count] of Object.entries(data.zone_counts)) html += `${name}: ${count} `;
                html += '</small>';
            }
            overlay.innerHTML = html;
        }
    }
}

function updateCamera2Stats(data) {
    const totalEl = document.getElementById('totalCount2');
    const statsEl = document.getElementById('zoneStats2');
    if (!totalEl || !statsEl) return;
    console.log('Updating Camera 2 stats:', data);
    const currTotal = parseInt(totalEl.textContent) || 0;
    const newTotal = data.total_count || 0;
    if (currTotal !== newTotal) {
        totalEl.textContent = newTotal;
        totalEl.classList.add('updated');
        setTimeout(() => totalEl.classList.remove('updated'), 500);
    }
    if (data.zone_counts && Object.keys(data.zone_counts).length) {
        let html = '';
        for (const [name, count] of Object.entries(data.zone_counts)) {
            const dispName = name.startsWith('z') ? `Zone ${name.substring(1)}` : name;
            const zone = cameras[2].savedZones.find(z => z.name === name || z.name === dispName);
            const color = zone ? zone.color : '#4ecdc4';
            html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:0.5rem;margin-bottom:0.25rem;background:rgba(255,255,255,0.1);border-radius:8px;border-left:4px solid ${color};transition:all 0.3s"><span style="font-weight:500">${dispName}</span><span style="font-weight:600;color:${color};font-size:1.1rem">${count}</span></div>`;
        }
        statsEl.innerHTML = html;
    } else if (cameras[2].yoloActive) {
        statsEl.innerHTML = '<p style="opacity:0.7;text-align:center;font-style:italic">No detections</p>';
    } else {
        statsEl.innerHTML = '<p style="opacity:0.7;text-align:center;font-style:italic">Start YOLO to see counts</p>';
    }
    if (data.fps) {
        const fpsEl = statsEl.parentElement.querySelector('.fps-display');
        if (!fpsEl) {
            const div = document.createElement('div');
            div.className = 'fps-display';
            div.style.cssText = 'text-align:center;margin-top:0.5rem;padding:0.25rem;background:rgba(255,255,255,0.05);border-radius:5px;font-size:0.8rem;opacity:0.8';
            statsEl.parentElement.appendChild(div);
        }
        statsEl.parentElement.querySelector('.fps-display').textContent = `FPS: ${data.fps.toFixed(1)}`;
    }
}

function updateProcessingButtonsWithState(id, ready) {
    console.log(`[BUTTON UPDATE] Camera ${id}:`, {
        isFullyReady: ready.isFullyReady,
        videoReady: ready.videoReady,
        hasZones: ready.hasZones,
        zonesLoaded: ready.zonesLoaded,
        processing: cameras[id].processing
    });
    
    if (id === 1) {
        // Camera 1 (Pi5) buttons
        const startBtn = document.getElementById('startYolo1');
        const stopBtn = document.getElementById('stopYolo1');
        const syncBtn = document.getElementById('syncZones1');
        
        if (!startBtn || !stopBtn) {
            console.error('[BUTTON UPDATE] Buttons not found for Camera 1');
            return;
        }
        
        const isProcessing = cameras[1].processing;
        
        if (isProcessing) {
            // YOLO is running
            startBtn.disabled = true;
            startBtn.innerHTML = '<i class="fas fa-brain"></i> YOLO Running';
            stopBtn.disabled = false;
            stopBtn.innerHTML = '<i class="fas fa-stop"></i> Stop';
        } else {
            // YOLO is not running
            // Enable Start button if: Pi5 connected AND zones exist
            const canStart = cameras[1].videoLoaded && 
                           cameras[1].savedZones && 
                           cameras[1].savedZones.length > 0;
            
            startBtn.disabled = !canStart;
            startBtn.innerHTML = '<i class="fas fa-brain"></i> Start YOLO';
            stopBtn.disabled = true;
            stopBtn.innerHTML = '<i class="fas fa-stop"></i> Stop';
            
            if (canStart) {
                startBtn.title = 'Ready to start YOLO processing';
                console.log('[BUTTON UPDATE]  Start button ENABLED for Camera 1');
            } else {
                if (!cameras[1].videoLoaded) {
                    startBtn.title = 'Connect to Pi5 first';
                    console.log('[BUTTON UPDATE]  Start button disabled: Pi5 not connected');
                } else if (!cameras[1].savedZones || cameras[1].savedZones.length === 0) {
                    startBtn.title = 'Create zones first';
                    console.log('[BUTTON UPDATE]  Start button disabled: No zones');
                }
            }
        }
        
        // Sync button: Enable if Pi5 connected and zones exist
        if (syncBtn) {
            const canSync = cameras[1].videoLoaded && 
                          cameras[1].savedZones && 
                          cameras[1].savedZones.length > 0;
            syncBtn.disabled = !canSync;
        }
        
    } else if (id === 2) {
        // Camera 2 (Video) buttons
        const startBtn = document.getElementById('startProcessing2');
        const stopBtn = document.getElementById('stopProcessing2');
        
        if (!startBtn || !stopBtn) return;
        
        const isProcessing = cameras[2].processing;
        
        if (isProcessing) {
            startBtn.disabled = true;
            startBtn.innerHTML = '<i class="fas fa-brain"></i> YOLO Running';
            stopBtn.disabled = false;
        } else {
            const canStart = ready.isFullyReady && ready.hasZones;
            startBtn.disabled = !canStart;
            stopBtn.disabled = true;
            
            if (canStart) {
                startBtn.innerHTML = '<i class="fas fa-brain"></i> Start YOLO';
                startBtn.title = 'Ready to start';
            } else {
                startBtn.innerHTML = '<i class="fas fa-brain"></i> Start YOLO';
                startBtn.title = !ready.videoReady ? 'Load video first' : 
                               !ready.hasZones ? 'Create zones first' : 'Not ready';
            }
        }
    }
}

function updateProcessingButtons(id, isProc) {
    const ready = checkCameraReadiness(id);
    updateProcessingButtonsWithState(id, ready);
}

function updateCameraYOLOStatus(id, statusData) {
    const { status, message } = statusData;
    const indicator = document.getElementById(`camera${id}Indicator`);
    const yoloStatus = document.getElementById(`yoloStatus${id}`);
    cameras[id].processing = ['starting', 'initializing', 'running'].includes(status);
    cameras[id].yoloActive = status === 'running';
    updateProcessingButtons(id, cameras[id].processing);
    indicator && (status === 'running' ? indicator.classList.add('active') : indicator.classList.remove('active'));
    if (yoloStatus) {
        yoloStatus.classList.remove('active', 'waiting');
        if (status === 'running') {
            yoloStatus.classList.add('active');
            yoloStatus.innerHTML = '<i class="fas fa-brain"></i> YOLO Active';
        } else if (status === 'starting' || status === 'initializing') {
            yoloStatus.classList.add('waiting');
            yoloStatus.innerHTML = '<i class="fas fa-cog fa-spin"></i> YOLO Starting...';
        } else if (status === 'stopping') {
            yoloStatus.classList.add('waiting');
            yoloStatus.innerHTML = '<i class="fas fa-stop"></i> YOLO Stopping...';
        } else if (status === 'error') {
            yoloStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> YOLO Error';
        }
    }
}

function showMessage(msg, type = 'info') {
    const existing = document.querySelector('.message');
    existing && existing.remove();
    const div = document.createElement('div');
    div.className = `message ${type}`;
    const icon = type === 'success' ? '<i class="fas fa-check-circle"></i>' : type === 'error' ? '<i class="fas fa-exclamation-triangle"></i>' : '<i class="fas fa-info-circle"></i>';
    div.innerHTML = `${icon} ${msg}`;
    document.body.appendChild(div);
    setTimeout(() => div.parentNode && div.remove(), 5000);
}

function logout() {
    if (confirm('Logout?')) {
        stopYOLOProcessing(1);
        stopYOLOProcessing(2);
        stopWebcam(1);
        localStorage.clear();
        window.location.href = '/';
    }
}

// Keyboard shortcuts
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
        const m1 = document.getElementById('camera1Modal');
        const m2 = document.getElementById('camera2Modal');
        m1.style.display === 'block' ? closeCameraModal(1) : m2.style.display === 'block' && closeCameraModal(2);
    }
    if (e.key === 'Enter') {
        const el = document.activeElement;
        el.id === 'zoneNameInput1' ? saveCurrentZone(1) : el.id === 'zoneNameInput2' && saveCurrentZone(2);
    }
});

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    stopWebcam(1);
    stopYOLOProcessing(1);
    stopYOLOProcessing(2);
});

// State validation interval
setInterval(() => {
    [1, 2].forEach(id => {
        const ready = checkCameraReadiness(id);
        const currReady = cameras[id].isReady;
        if (ready.isFullyReady !== currReady) {
            console.log(`Camera ${id} readiness changed: ${currReady} -> ${ready.isFullyReady}`);
            updateCameraState(id, { isReady: ready.isFullyReady });
        }
    });
}, 3000);

// Debug function
window.debugCameraState = (id) => {
    const c = cameras[id];
    const r = checkCameraReadiness(id);
    console.log(`=== Camera ${id} Debug ===`);
    console.log('Camera:', c);
    console.log('Readiness:', r);
    console.log('Video:', c.video);
    console.log('Ready state:', c.video ? c.video.readyState : 'N/A');
    console.log('Dimensions:', `${c.videoWidth}x${c.videoHeight}`);
    console.log('Canvas:', `${c.canvasWidth}x${c.canvasHeight}`);
    console.log('Zones:', c.savedZones ? c.savedZones.length : 0);
    console.log('=========================');
};
function openAnalyticsDashboard() {
    window.open('/analytics-dashboard.html', '_blank');
    showMessage('Opening Live Analytics Dashboard...', 'info');
}
    </script>
</body>
</html>